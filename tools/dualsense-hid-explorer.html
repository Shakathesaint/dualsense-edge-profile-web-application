<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DualSense Edge HID Explorer</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-card: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-blue: #0070d1;
            --accent-green: #238636;
            --accent-red: #da3633;
            --accent-yellow: #d29922;
            --border-color: #30363d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #0070d1, #00a3e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .connection-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
        }

        .status-dot.connected {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0080e8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #2d333b;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-warning {
            background: var(--accent-yellow);
            color: black;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .panel-actions button {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .panel-content {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .hex-display {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .report-item {
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 3px solid var(--accent-blue);
        }

        .report-id {
            color: var(--accent-blue);
            font-weight: bold;
            margin-bottom: 6px;
        }

        .report-error {
            border-left-color: var(--accent-red);
        }

        .report-error .report-id {
            color: var(--accent-red);
        }

        .byte {
            display: inline-block;
            padding: 2px 4px;
            margin: 1px;
            border-radius: 3px;
            background: var(--bg-primary);
        }

        .byte.changed {
            background: var(--accent-red);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .snapshot-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .snapshot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .snapshot-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .snapshots-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 800px) {
            .snapshots-container {
                grid-template-columns: 1fr;
            }
        }

        .snapshot-box {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
        }

        .snapshot-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-blue);
        }

        .instructions {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }

        .instructions h3 {
            margin-bottom: 12px;
            color: var(--accent-yellow);
        }

        .instructions ol {
            padding-left: 20px;
            color: var(--text-secondary);
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .instructions code {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-primary);
        }

        .diff-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .diff-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-green);
        }

        .no-changes {
            color: var(--text-secondary);
            font-style: italic;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .log-time {
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .input-counter {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .export-section {
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>üéÆ DualSense Edge HID Explorer</h1>
    <p class="subtitle">Diagnostic tool for reverse-engineering HID reports</p>

    <!-- Connection Panel -->
    <div class="connection-panel">
        <div class="status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Disconnected</span>
        </div>
        <button class="btn-primary" id="connectBtn" onclick="connectController()">Connect Controller</button>
        <button class="btn-secondary" id="disconnectBtn" onclick="disconnectController()" disabled>Disconnect</button>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Feature Reports Panel -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üìã Feature Reports</span>
                <div class="panel-actions">
                    <button class="btn-secondary" id="scanBtn" onclick="scanFeatureReports()" disabled>Scan All
                        (0x00-0xFF)</button>
                    <button class="btn-secondary" id="clearFeatureBtn" onclick="clearFeatureReports()">Clear</button>
                </div>
            </div>
            <div class="panel-content" id="featureReportsContent">
                <p style="color: var(--text-secondary);">Connect controller and click "Scan All" to read all Feature
                    Reports.</p>
            </div>
        </div>

        <!-- Input Report Monitor -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">üì° Input Report Monitor <span class="input-counter" id="inputCounter">(0
                        received)</span></span>
                <div class="panel-actions">
                    <button class="btn-success" id="startMonitorBtn" onclick="startInputMonitor()" disabled>Start
                        Monitor</button>
                    <button class="btn-secondary" id="stopMonitorBtn" onclick="stopInputMonitor()"
                        disabled>Stop</button>
                    <button class="btn-secondary" onclick="clearInputMonitor()">Clear</button>
                </div>
            </div>
            <div class="panel-content" id="inputReportsContent">
                <p style="color: var(--text-secondary);">Start monitor to see live Input Reports.</p>
            </div>
        </div>
    </div>

    <!-- Snapshot & Diff Panel -->
    <div class="snapshot-panel">
        <div class="snapshot-header">
            <h3>üì∏ Snapshot & Diff Analysis</h3>
            <div class="snapshot-controls">
                <button class="btn-primary" id="snapshot1Btn" onclick="takeSnapshot(1)" disabled>Take Snapshot
                    A</button>
                <button class="btn-primary" id="snapshot2Btn" onclick="takeSnapshot(2)" disabled>Take Snapshot
                    B</button>
                <button class="btn-warning" id="compareBtn" onclick="compareSnapshots()" disabled>Compare A vs
                    B</button>
                <button class="btn-secondary" onclick="clearSnapshots()">Clear All</button>
                <label
                    style="display: flex; align-items: center; gap: 6px; margin-left: 16px; color: var(--text-secondary); font-size: 0.85rem;">
                    <input type="checkbox" id="noiseFilterCheckbox" checked onchange="toggleNoiseFilter()">
                    üîá Filter noise (IMU, joystick drift, checksum)
                </label>
            </div>
        </div>
        <div class="snapshots-container">
            <div class="snapshot-box">
                <div class="snapshot-label">Snapshot A</div>
                <div class="hex-display" id="snapshot1Content">No snapshot taken</div>
            </div>
            <div class="snapshot-box">
                <div class="snapshot-label">Snapshot B</div>
                <div class="hex-display" id="snapshot2Content">No snapshot taken</div>
            </div>
        </div>
        <div class="diff-result" id="diffResult" style="display: none;">
            <div class="diff-title">üîç Differences Found:</div>
            <div id="diffContent"></div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="instructions">
        <h3>üìñ How to Find the Active Profile Byte</h3>
        <ol>
            <li>Connect your <strong>DualSense Edge</strong> via USB cable</li>
            <li>Click <code>Connect Controller</code> to establish WebHID connection</li>
            <li>Click <code>Scan All</code> to read all Feature Reports (may take a moment)</li>
            <li>Start the <strong>Input Monitor</strong> to observe live data</li>
            <li>Click <code>Take Snapshot A</code> to capture current state</li>
            <li>On the controller, press <code>FN + ‚ñ≥/‚óã/‚úï/‚ñ°</code> to switch profile</li>
            <li>Click <code>Take Snapshot B</code> after switching</li>
            <li>Click <code>Compare A vs B</code> to see which bytes changed</li>
            <li>Repeat with different profile switches to confirm the pattern</li>
        </ol>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <button class="btn-secondary" onclick="exportFindings()">üì• Export Findings as JSON</button>
    </div>

    <script>
        // State
        let hidDevice = null;
        let inputMonitorActive = false;
        let inputReportCount = 0;
        let lastInputReport = null;
        let snapshot1 = null;
        let snapshot2 = null;
        let featureReportsData = {};
        let findings = [];

        // Noise filter - ONLY the most volatile bytes
        // Reduced filter to avoid hiding potential profile slot data
        const NOISE_BYTES = new Set([
            // Bytes 0-6: Joystick axes and triggers (definitely analog drift)
            0, 1, 2, 3, 4, 5, 6,
            // Bytes 52-62: Timestamp/sequence counter/checksum at end
            52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62
        ]);
        // NOTE: Bytes 7-51 are kept visible for profile slot analysis
        // The profile slot might be in byte 19 (showed 1‚Üí3 in tests)

        // Enable/disable noise filtering
        let noiseFilterEnabled = true;

        const SONY_VENDOR_ID = 0x054C;
        const DUALSENSE_EDGE_PRODUCT_ID = 0x0DF2;

        // Connection
        async function connectController() {
            try {
                const devices = await navigator.hid.requestDevice({
                    filters: [{ vendorId: SONY_VENDOR_ID, productId: DUALSENSE_EDGE_PRODUCT_ID }]
                });

                if (devices.length === 0) {
                    alert('No DualSense Edge controller selected.');
                    return;
                }

                hidDevice = devices[0];
                await hidDevice.open();

                hidDevice.addEventListener('inputreport', handleInputReport);

                updateConnectionStatus(true);
                log('Connected to: ' + hidDevice.productName);

            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect: ' + error.message);
            }
        }

        async function disconnectController() {
            if (hidDevice) {
                stopInputMonitor();
                await hidDevice.close();
                hidDevice = null;
            }
            updateConnectionStatus(false);
            log('Disconnected');
        }

        function updateConnectionStatus(connected) {
            document.getElementById('statusDot').classList.toggle('connected', connected);
            document.getElementById('statusText').textContent = connected ? 'Connected' : 'Disconnected';
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('scanBtn').disabled = !connected;
            document.getElementById('startMonitorBtn').disabled = !connected;
            document.getElementById('snapshot1Btn').disabled = !connected;
            document.getElementById('snapshot2Btn').disabled = !connected;
        }

        // Feature Reports
        async function scanFeatureReports() {
            if (!hidDevice) return;

            const content = document.getElementById('featureReportsContent');
            content.innerHTML = '<p style="color: var(--accent-yellow);">Scanning... please wait</p>';
            featureReportsData = {};

            let html = '';
            const skipReports = []; // We'll read all, including 0x70-0x7B for comparison

            for (let reportId = 0; reportId <= 255; reportId++) {
                try {
                    const report = await hidDevice.receiveFeatureReport(reportId);
                    const bytes = new Uint8Array(report.buffer);

                    featureReportsData[reportId] = bytes;

                    const hexStr = formatHexBytes(bytes);
                    const isProfileReport = reportId >= 0x70 && reportId <= 0x7B;

                    html += `<div class="report-item${isProfileReport ? ' profile-report' : ''}">
                        <div class="report-id">Report 0x${reportId.toString(16).toUpperCase().padStart(2, '0')} (${reportId}) - ${bytes.length} bytes ${isProfileReport ? '(Profile Data)' : ''}</div>
                        <div class="hex-display">${hexStr}</div>
                    </div>`;

                } catch (error) {
                    // Most reports will fail, that's expected
                    if (reportId % 16 === 0) {
                        // Only log every 16th error to reduce noise
                    }
                }
            }

            if (html === '') {
                html = '<p style="color: var(--text-secondary);">No readable Feature Reports found.</p>';
            }

            content.innerHTML = html;
            log(`Scan complete. Found ${Object.keys(featureReportsData).length} readable reports.`);
        }

        function clearFeatureReports() {
            document.getElementById('featureReportsContent').innerHTML =
                '<p style="color: var(--text-secondary);">Connect controller and click "Scan All" to read all Feature Reports.</p>';
            featureReportsData = {};
        }

        // Input Reports
        function handleInputReport(event) {
            if (!inputMonitorActive) return;

            inputReportCount++;
            document.getElementById('inputCounter').textContent = `(${inputReportCount} received)`;

            const bytes = new Uint8Array(event.data.buffer);
            lastInputReport = {
                reportId: event.reportId,
                bytes: bytes,
                timestamp: new Date()
            };

            // Update display - show only the latest report
            const content = document.getElementById('inputReportsContent');
            const hexStr = formatHexBytesWithPositions(bytes);

            content.innerHTML = `
                <div class="report-item">
                    <div class="report-id">Report 0x${event.reportId.toString(16).toUpperCase().padStart(2, '0')} - ${bytes.length} bytes</div>
                    <div class="hex-display">${hexStr}</div>
                </div>
            `;
        }

        function startInputMonitor() {
            inputMonitorActive = true;
            inputReportCount = 0;
            document.getElementById('startMonitorBtn').disabled = true;
            document.getElementById('stopMonitorBtn').disabled = false;
            document.getElementById('inputReportsContent').innerHTML =
                '<p style="color: var(--accent-yellow);">Waiting for input reports...</p>';
            log('Input monitor started');
        }

        function stopInputMonitor() {
            inputMonitorActive = false;
            document.getElementById('startMonitorBtn').disabled = !hidDevice;
            document.getElementById('stopMonitorBtn').disabled = true;
            log('Input monitor stopped');
        }

        function clearInputMonitor() {
            document.getElementById('inputReportsContent').innerHTML =
                '<p style="color: var(--text-secondary);">Start monitor to see live Input Reports.</p>';
            inputReportCount = 0;
            document.getElementById('inputCounter').textContent = '(0 received)';
        }

        // Snapshots
        function takeSnapshot(num) {
            if (!lastInputReport) {
                alert('No input report captured yet. Start the monitor and move a joystick first.');
                return;
            }

            const snapshot = {
                bytes: new Uint8Array(lastInputReport.bytes),
                reportId: lastInputReport.reportId,
                timestamp: new Date()
            };

            if (num === 1) {
                snapshot1 = snapshot;
                document.getElementById('snapshot1Content').innerHTML = formatHexBytesWithPositions(snapshot.bytes);
                log('Snapshot A taken');
            } else {
                snapshot2 = snapshot;
                document.getElementById('snapshot2Content').innerHTML = formatHexBytesWithPositions(snapshot.bytes);
                log('Snapshot B taken');
            }

            document.getElementById('compareBtn').disabled = !(snapshot1 && snapshot2);
        }

        function compareSnapshots() {
            if (!snapshot1 || !snapshot2) {
                alert('Please take both snapshots first.');
                return;
            }

            const allDifferences = [];
            const len = Math.max(snapshot1.bytes.length, snapshot2.bytes.length);

            for (let i = 0; i < len; i++) {
                const a = snapshot1.bytes[i] ?? 'N/A';
                const b = snapshot2.bytes[i] ?? 'N/A';
                if (a !== b) {
                    allDifferences.push({
                        position: i,
                        byteA: a,
                        byteB: b,
                        isNoise: NOISE_BYTES.has(i)
                    });
                }
            }

            const differences = noiseFilterEnabled
                ? allDifferences.filter(d => !d.isNoise)
                : allDifferences;

            const diffResult = document.getElementById('diffResult');
            const diffContent = document.getElementById('diffContent');

            const noiseCount = allDifferences.length - differences.length;
            const statsHtml = `<p style="margin-bottom: 12px; color: var(--text-secondary);">Total: <strong>${allDifferences.length}</strong> | Noise filtered: <strong style="color: var(--accent-red);">${noiseCount}</strong> | Showing: <strong style="color: var(--accent-green);">${differences.length}</strong></p>`;

            if (differences.length === 0) {
                diffContent.innerHTML = statsHtml + '<p class="no-changes">No significant differences (all changes are noise bytes - try unchecking filter).</p>';
            } else {
                let html = statsHtml + '<table style="width: 100%; font-family: monospace; border-collapse: collapse;">';
                html += '<tr style="color: var(--accent-blue);"><th style="text-align:left;padding:6px;">Byte</th><th>A</th><th>B</th><th style="text-align:left;">Meaning</th></tr>';

                differences.forEach(d => {
                    let meaning = '';
                    let rowStyle = d.isNoise ? 'opacity:0.5;' : '';
                    // Known positions from DualSense standard
                    if (d.position === 7) { meaning = '‚≠ê <strong>VENDOR BYTE - Profile slot?</strong>'; rowStyle = 'background:rgba(35,134,54,0.2);'; }
                    else if (d.position === 8) meaning = 'üéÆ D-pad + face buttons';
                    else if (d.position === 9) meaning = 'üéÆ Shoulder buttons';
                    else if (d.position === 10) meaning = 'üéÆ PS/Mute/Touchpad';
                    else if (d.position >= 45 && d.position <= 47) { meaning = '‚≠ê <strong>Status byte</strong>'; rowStyle = 'background:rgba(35,134,54,0.2);'; }
                    else if (d.isNoise) meaning = 'üî¥ Noise (filtered)';
                    else { meaning = '‚≠ê <strong>Investigate!</strong>'; rowStyle = 'background:rgba(35,134,54,0.2);'; }

                    html += `<tr style="${rowStyle}">
                        <td style="padding:6px; color: var(--accent-yellow);">Byte ${d.position} (0x${d.position.toString(16).toUpperCase().padStart(2, '0')})</td>
                        <td style="padding:6px;">0x${typeof d.byteA === 'number' ? d.byteA.toString(16).toUpperCase().padStart(2, '0') : d.byteA}</td>
                        <td style="padding:6px;">0x${typeof d.byteB === 'number' ? d.byteB.toString(16).toUpperCase().padStart(2, '0') : d.byteB}</td>
                        <td style="padding:6px;">${meaning}</td>
                    </tr>`;
                });
                html += '</table>';

                // Save to findings
                findings.push({
                    timestamp: new Date().toISOString(),
                    differences: differences,
                    snapshot1Length: snapshot1.bytes.length,
                    snapshot2Length: snapshot2.bytes.length
                });

                diffContent.innerHTML = html;
            }

            diffResult.style.display = 'block';
            log(`Comparison complete: ${differences.length} differences found`);
        }

        function clearSnapshots() {
            snapshot1 = null;
            snapshot2 = null;
            document.getElementById('snapshot1Content').textContent = 'No snapshot taken';
            document.getElementById('snapshot2Content').textContent = 'No snapshot taken';
            document.getElementById('diffResult').style.display = 'none';
            document.getElementById('compareBtn').disabled = true;
        }

        function toggleNoiseFilter() {
            noiseFilterEnabled = document.getElementById('noiseFilterCheckbox').checked;
            if (snapshot1 && snapshot2) {
                compareSnapshots();
            }
        }

        // Utilities
        function formatHexBytes(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).toUpperCase().padStart(2, '0'))
                .join(' ');
        }

        function formatHexBytesWithPositions(bytes) {
            let html = '';
            for (let i = 0; i < bytes.length; i++) {
                if (i % 16 === 0) {
                    if (i > 0) html += '\n';
                    html += `<span style="color: var(--text-secondary);">${i.toString(16).toUpperCase().padStart(4, '0')}:</span> `;
                }
                html += `<span class="byte" title="Byte ${i}">${bytes[i].toString(16).toUpperCase().padStart(2, '0')}</span>`;
            }
            return html;
        }

        function log(message) {
            console.log(`[HID Explorer] ${message}`);
        }

        function exportFindings() {
            const exportData = {
                exportDate: new Date().toISOString(),
                device: hidDevice ? {
                    productName: hidDevice.productName,
                    vendorId: hidDevice.vendorId,
                    productId: hidDevice.productId
                } : null,
                featureReports: {},
                findings: findings
            };

            // Convert feature reports to exportable format
            for (const [id, bytes] of Object.entries(featureReportsData)) {
                exportData.featureReports[id] = Array.from(bytes);
            }

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dualsense-edge-hid-findings-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('Findings exported');
        }

        // Check WebHID support
        if (!navigator.hid) {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h1 style="color: var(--accent-red);">‚ùå WebHID Not Supported</h1>
                    <p style="color: var(--text-secondary); margin-top: 20px;">
                        This browser does not support the WebHID API.<br>
                        Please use <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong> on desktop.
                    </p>
                </div>
            `;
        }
    </script>
</body>

</html>